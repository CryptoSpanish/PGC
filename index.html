<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Explorador PGC ¬∑ Cuadro de Cuentas</title>
<meta name="description" content="Tabla avanzada del PGC con buscador, filtros y explicaci√≥n t√©cnica por c√≥digo" />
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1621; --muted:#7e8aa0; --text:#e7eef8; --accent:#5dd0ff;
    --accent-2:#90f0c4; --danger:#ff6b6b; --ok:#a0ff6b; --warn:#ffd56b;
    --card:#0d131d; --border:#1b2431; --chip:#132032; --hl:#263246;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial;
    color:var(--text); background:
      radial-gradient(1200px 800px at 10% -10%, #142033 0%, transparent 60%),
      radial-gradient(1200px 800px at 110% 10%, #132733 0%, transparent 60%),
      linear-gradient(180deg, #0a0e13, #0b0f14);
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg, rgba(13,19,29,.9), rgba(13,19,29,.65));
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:16px 20px}
  h1{margin:0; font-size:1.5rem; letter-spacing:.2px; display:flex; gap:.6rem; align-items:center}
  h1 .dot{width:10px; height:10px; border-radius:50%; background:var(--accent);
    box-shadow:0 0 14px var(--accent)}
  .sub{color:var(--muted); font-size:.95rem; margin-top:6px}

  .toolbar{
    display:grid; grid-template-columns:1.4fr .8fr .8fr auto; gap:10px; margin-top:14px
  }
  .control{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:center
  }
  .control input[type="text"]{all:unset; flex:1; font-size:0.98rem}
  .control select{all:unset; font-size:.95rem; background:var(--chip); padding:6px 10px; border-radius:10px; border:1px solid var(--border)}
  .btn{
    background:linear-gradient(180deg,#172235,#121b2b); border:1px solid var(--border); color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s transform, .2s opacity
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn-accent{border-color:#1d314a; box-shadow:0 0 0 1px #1d314a inset; color:#dff6ff}
  .btn-secondary{background:#142032}

  main{display:grid; grid-template-columns: 1fr 360px; gap:14px; margin-top:16px}
  @media (max-width:980px){ main{grid-template-columns:1fr} }

  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden
  }
  .card h2{margin:0; padding:12px 14px; font-size:1rem; border-bottom:1px solid var(--border); background:#0f1723}
  .table-wrap{max-height:66vh; overflow:auto}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{
    position:sticky; top:0; background:#101827; z-index:1; font-size:.88rem;
    border-bottom:1px solid var(--border); color:#b9c8df; text-align:left; padding:10px
  }
  tbody tr{border-bottom:1px solid var(--border)}
  tbody tr:hover{background:var(--hl)}
  td{padding:10px; font-size:.95rem; vertical-align:top}
  td.code{font-variant-numeric:tabular-nums; font-weight:700; color:#d9f1ff}
  td.badge span{display:inline-block; padding:3px 8px; border-radius:999px; font-size:.75rem; border:1px solid var(--border); background:var(--chip)}
  mark{background:transparent; color:inherit; position:relative}
  mark::after{
    content:""; position:absolute; inset:-1px 0 -2px 0; background:linear-gradient(90deg, transparent, rgba(93,208,255,.25), transparent);
    border-bottom:1px dashed rgba(93,208,255,.35); pointer-events:none
  }
  .footer-tools{display:flex; justify-content:space-between; padding:10px 12px; align-items:center; gap:8px; border-top:1px solid var(--border)}
  .pager{display:flex; gap:6px; align-items:center}
  .pager .btn{padding:6px 10px; font-size:.9rem}
  .muted{color:var(--muted); font-size:.9rem}

  .details{display:flex; flex-direction:column; gap:10px}
  .kv{display:grid; grid-template-columns:120px 1fr; gap:4px 10px; padding:10px 12px}
  .kv div:nth-child(odd){color:#a8b7cf; font-size:.88rem}
  .kv div:nth-child(even){color:#e5f0ff}
  .chips{display:flex; flex-wrap:wrap; gap:6px; padding:0 12px 10px}
  .chip{background:var(--chip); border:1px solid var(--border); padding:4px 8px; font-size:.8rem; border-radius:999px}
  .note{border-top:1px dashed var(--border); padding:10px 12px; color:#cfe8ff}
  .note textarea{
    width:100%; min-height:90px; background:#0c1522; color:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; resize:vertical
  }
  .drop{
    border:1px dashed #2d4160; background:#0b121d; color:#c9def3; text-align:center; padding:12px; border-radius:12px
  }
  .drop.drag{outline:2px solid var(--accent)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="dot"></span> Explorador del Plan General Contable (PGC)</h1>
    <div class="sub">Tabla con buscador + explicaci√≥n t√©cnica por c√≥digo. Si existe un archivo <strong>pgc_cuadro_cuentas_demo.json</strong> en esta misma carpeta, lo cargar√© autom√°ticamente.</div>
    <div class="toolbar">
      <div class="control">
        üîé <input id="q" type="text" placeholder="Buscar por c√≥digo, nombre o texto‚Ä¶ (p. ej., 430, clientes, bancos)" />
      </div>
      <div class="control">
        <select id="fGroup" title="Filtrar por grupo">
          <option value="">Grupo (1‚Äì9)</option>
        </select>
        <select id="fNature" title="Filtrar por naturaleza">
          <option value="">Naturaleza</option>
          <option>Activo</option>
          <option>Pasivo</option>
          <option>Patrimonio neto</option>
          <option>Gasto</option>
          <option>Ingreso</option>
        </select>
      </div>
      <div class="control drop" id="drop">Arrastra aqu√≠ tu JSON del Cuadro de Cuentas</div>
      <div class="control" style="gap:8px; justify-content:flex-end">
        <button class="btn btn-secondary" id="btnImport">Importar JSON</button>
        <input id="file" type="file" accept=".json,application/json" hidden />
        <button class="btn btn-accent" id="btnReset">Restablecer</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <main>
    <section class="card">
      <h2>Cuadro de cuentas ¬∑ resultados <span id="count" class="muted"></span></h2>
      <div class="table-wrap">
        <table id="grid">
          <thead>
            <tr>
              <th data-k="code">C√≥digo</th>
              <th data-k="name">Nombre</th>
              <th data-k="group">Grupo</th>
              <th data-k="subgroup">Subgrupo</th>
              <th data-k="nature">Naturaleza</th>
              <th data-k="present">Presentaci√≥n</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="footer-tools">
        <div class="pager">
          <button class="btn" id="prev">‚Üê</button>
          <span class="muted" id="pageInfo"></span>
          <button class="btn" id="next">‚Üí</button>
        </div>
        <div class="muted">Haz clic en una fila para ver la explicaci√≥n t√©cnica.</div>
      </div>
    </section>

    <aside class="card">
      <h2>Explicaci√≥n t√©cnica del c√≥digo</h2>
      <div class="details" id="details">
        <div class="kv">
          <div>C√≥digo</div><div id="d_code" class="strong">‚Äî</div>
          <div>Nombre</div><div id="d_name">‚Äî</div>
          <div>Jerarqu√≠a</div><div id="d_path">‚Äî</div>
          <div>Naturaleza</div><div id="d_nature">‚Äî</div>
          <div>Saldo normal</div><div id="d_balance">‚Äî</div>
          <div>Presentaci√≥n</div><div id="d_present">‚Äî</div>
        </div>
        <div class="chips" id="chips"></div>
        <div class="note">
          <div style="margin:6px 0 8px; color:#a7bad4; font-size:.9rem">Notas del usuario (opcional)</div>
          <textarea id="d_notes" placeholder="A√±ade aqu√≠ cualquier precisi√≥n o referencia interna sobre el uso de esta cuenta‚Ä¶"></textarea>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
// 1) DEMO m√≠nimo de seguridad por si no hay JSON externo
const demo = [
  {"code":"100","name":"Capital social","group":"1 ‚Äì Financiaci√≥n b√°sica","subgroup":"10 ‚Äì Capital"},
  {"code":"118","name":"Aportaciones de socios o propietarios","group":"1 ‚Äì Financiaci√≥n b√°sica","subgroup":"11 ‚Äì Reservas y otros"},
  {"code":"170","name":"Deudas a largo plazo con entidades de cr√©dito","group":"1 ‚Äì Financiaci√≥n b√°sica","subgroup":"17 ‚Äì Deudas a largo plazo"},
  {"code":"200","name":"Investigaci√≥n","group":"2 ‚Äì Inmovilizado intangible","subgroup":"20 ‚Äì Inmovilizado intangible"},
  {"code":"213","name":"Maquinaria","group":"2 ‚Äì Inmovilizado material","subgroup":"21 ‚Äì Inmovilizado material"},
  {"code":"300","name":"Mercader√≠as","group":"3 ‚Äì Existencias","subgroup":"30 ‚Äì Mercader√≠as"},
  {"code":"400","name":"Proveedores","group":"4 ‚Äì Acreedores y deudores por operaciones comerciales","subgroup":"40 ‚Äì Proveedores"},
  {"code":"410","name":"Acreedores por prestaciones de servicios","group":"4 ‚Äì Acreedores y deudores por operaciones comerciales","subgroup":"41 ‚Äì Acreedores varios"},
  {"code":"430","name":"Clientes","group":"4 ‚Äì Acreedores y deudores por operaciones comerciales","subgroup":"43 ‚Äì Clientes"},
  {"code":"470","name":"H.P. deudora por diversos conceptos","group":"4 ‚Äì Acreedores y deudores por operaciones comerciales","subgroup":"47 ‚Äì Hacienda P√∫blica"},
  {"code":"477","name":"H.P. IVA repercutido","group":"4 ‚Äì Acreedores y deudores por operaciones comerciales","subgroup":"47 ‚Äì Hacienda P√∫blica"},
  {"code":"520","name":"Deudas a corto plazo con entidades de cr√©dito","group":"5 ‚Äì Cuentas financieras","subgroup":"52 ‚Äì Deudas a corto plazo"},
  {"code":"570","name":"Caja","group":"5 ‚Äì Cuentas financieras","subgroup":"57 ‚Äì Tesorer√≠a"},
  {"code":"572","name":"Bancos","group":"5 ‚Äì Cuentas financieras","subgroup":"57 ‚Äì Tesorer√≠a"},
  {"code":"600","name":"Compras de mercader√≠as","group":"6 ‚Äì Compras y gastos","subgroup":"60 ‚Äì Compras"},
  {"code":"622","name":"Reparaciones y conservaci√≥n","group":"6 ‚Äì Compras y gastos","subgroup":"62 ‚Äì Servicios exteriores"},
  {"code":"700","name":"Ventas de mercader√≠as","group":"7 ‚Äì Ventas e ingresos","subgroup":"70 ‚Äì Ventas"},
  {"code":"705","name":"Prestaciones de servicios","group":"7 ‚Äì Ventas e ingresos","subgroup":"70 ‚Äì Ventas/Servicios"},
  {"code":"800","name":"Gastos por valoraci√≥n de instrumentos financieros","group":"8 ‚Äì Gastos imputados al patrimonio neto","subgroup":"80 ‚Äì Ajustes a PN (gastos)"},
  {"code":"900","name":"Ingresos por valoraci√≥n de instrumentos financieros","group":"9 ‚Äì Ingresos imputados al patrimonio neto","subgroup":"90 ‚Äì Ajustes a PN (ingresos)"}
];

// 2) Reglas de naturaleza/saldo/presentaci√≥n
function rulesFor(code){
  const g = String(code).trim()[0];
  let nature="", balance="", present="", tags=[];
  switch(g){
    case "1":
      nature = (code.startsWith("10")||code.startsWith("11")) ? "Patrimonio neto" : "Pasivo";
      balance = "Acreedor"; present="Balance (no corriente / financiaci√≥n b√°sica)"; break;
    case "2": nature="Activo"; balance="Deudor"; present="Balance (activo no corriente)"; break;
    case "3": nature="Activo"; balance="Deudor"; present="Balance (existencias ¬∑ activo corriente)"; break;
    case "4":
      if (/^43/.test(code)) { nature="Activo"; balance="Deudor"; present="Balance (cr√©ditos comerciales ¬∑ corriente)"; }
      else if (/^47/.test(code)) { nature="Activo/Pasivo"; balance="Mixto"; present="Balance (Hacienda P√∫blica ¬∑ corriente)"; tags.push("Regularizable"); }
      else { nature="Pasivo"; balance="Acreedor"; present="Balance (deudas comerciales ¬∑ corriente)"; }
      break;
    case "5":
      if (/^57/.test(code)) { nature="Activo"; balance="Deudor"; present="Balance (tesorer√≠a ¬∑ corriente)"; }
      else if (/^52/.test(code)) { nature="Pasivo"; balance="Acreedor"; present="Balance (deudas financieras ¬∑ corriente)"; }
      else { nature="Activo/Pasivo"; balance="Mixto"; present="Balance (cuentas financieras)"; }
      break;
    case "6": nature="Gasto"; balance="Deudor"; present="Cuenta de P√©rdidas y Ganancias (gastos)"; break;
    case "7": nature="Ingreso"; balance="Acreedor"; present="Cuenta de P√©rdidas y Ganancias (ingresos)"; break;
    case "8": nature="Gasto"; balance="Deudor"; present="Estado de Cambios en el Patrimonio Neto (gastos)"; break;
    case "9": nature="Ingreso"; balance="Acreedor"; present="Estado de Cambios en el Patrimonio Neto (ingresos)"; break;
  }
  if (g==="6"||g==="7") tags.push("Devengo","PyG");
  if (g==="8"||g==="9") tags.push("Ajuste a PN");
  return {nature,balance,present,tags};
}

// 3) Estado + utilidades
let data = [];     // se rellenar√° con el JSON externo o DEMO
let filtered = []; let page = 1, pageSize = 12, selection = null;

const $=(s,c=document)=>c.querySelector(s);
const rows = $("#rows"), q=$("#q"), fGroup=$("#fGroup"), fNature=$("#fNature");
const pageInfo=$("#pageInfo"), count=$("#count");

function initFilters(){
  const groups = [...new Set(data.map(x=>String(x.code)[0]))].sort();
  fGroup.innerHTML = '<option value=\"\">Grupo (1‚Äì9)</option>' + groups.map(g=>{
    const label = ({
      "1":"1 ‚Äì Financiaci√≥n b√°sica","2":"2 ‚Äì Activo no corriente","3":"3 ‚Äì Existencias",
      "4":"4 ‚Äì Acreedores y deudores por operaciones comerciales","5":"5 ‚Äì Cuentas financieras",
      "6":"6 ‚Äì Compras y gastos","7":"7 ‚Äì Ventas e ingresos","8":"8 ‚Äì Gastos a PN","9":"9 ‚Äì Ingresos a PN"
    })[g] || (g+\" ‚Äì Grupo\");
    return `<option value=\"${g}\">${label}</option>`;
  }).join(\"\");
}
function normalizeRecord(r){
  const meta = rulesFor(r.code);
  return {...r, group: r.group || `${String(r.code)[0]} ‚Äì Grupo`, nature: r.nature || meta.nature,
          balance: r.balance || meta.balance, present: r.present || meta.present, _tags: meta.tags};
}
function applyFilters(){
  const term = q.value.trim().toLowerCase();
  const g = fGroup.value; const n = fNature.value;
  const withMeta = data.map(normalizeRecord);
  filtered = withMeta.filter(r=>{
    const passG = g ? String(r.code).startsWith(g) : true;
    const passN = n ? r.nature===n : true;
    const text = [r.code,r.name,r.group,r.subgroup,r.nature,r.present].join(\" \").toLowerCase();
    const passQ = term ? text.includes(term) : true;
    return passG && passN && passQ;
  });
  page=1; render();
}
function hl(text, term){
  if(!term) return text;
  const esc = term.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');
  return text.replace(new RegExp(esc, \"ig\"), m=>`<mark>${m}</mark>`);
}
function render(){
  const term = q.value.trim();
  const total = filtered.length;
  const start = (page-1)*pageSize; const end = Math.min(start+pageSize, total);
  const view = filtered.slice(start, end);
  rows.innerHTML = view.map(r=>{
    return `<tr data-code=\"${r.code}\">
      <td class=\"code\">${hl(r.code, term)}</td>
      <td>${hl(r.name, term)}</td>
      <td class=\"badge\"><span>${hl(r.group, term)}</span></td>
      <td class=\"badge\"><span>${hl(r.subgroup||\"‚Äî\", term)}</span></td>
      <td>${r.nature||\"‚Äî\"}</td>
      <td>${r.present||\"‚Äî\"}</td>
    </tr>`;
  }).join(\"\");
  count.textContent = total ? `¬∑ ${total.toLocaleString(\"es-ES\")} coincidencia(s)` : \"¬∑ 0\";
  pageInfo.textContent = total ? `P√°gina ${page} ¬∑ ${start+1}‚Äì${end} / ${total}` : \"Sin resultados\";
}
function selectByCode(code){
  const r = filtered.find(x=>x.code===code) || data.map(normalizeRecord).find(x=>x.code===code);
  selection = r || null; renderDetails();
}
function renderDetails(){
  const d = selection;
  $(\"#d_code\").textContent = d ? d.code : \"‚Äî\";
  $(\"#d_name\").textContent = d ? d.name : \"‚Äî\";
  $(\"#d_path\").textContent = d ? `${d.group||\"‚Äî\"} ‚Üí ${d.subgroup||\"‚Äî\"} ‚Üí ${d.code}` : \"‚Äî\";
  $(\"#d_nature\").textContent = d ? d.nature||\"‚Äî\" : \"‚Äî\";
  $(\"#d_balance\").textContent = d ? d.balance||\"‚Äî\" : \"‚Äî\";
  $(\"#d_present\").textContent = d ? d.present||\"‚Äî\" : \"‚Äî\";
  const chips = $(\"#chips\"); chips.innerHTML = \"\";
  if (d && d._tags) d._tags.forEach(t=>{ const el=document.createElement(\"span\"); el.className=\"chip\"; el.textContent=t; chips.appendChild(el); });
}

// Eventos
q.addEventListener(\"input\", applyFilters);
fGroup.addEventListener(\"change\", applyFilters);
fNature.addEventListener(\"change\", applyFilters);
document.querySelector(\"#prev\").addEventListener(\"click\", ()=>{ if(page>1){ page--; render(); }});
document.querySelector(\"#next\").addEventListener(\"click\", ()=>{ const pages=Math.ceil(filtered.length/pageSize); if(page<pages){ page++; render(); }});
document.querySelector(\"#rows\").addEventListener(\"click\", e=>{ const tr=e.target.closest(\"tr\"); if(!tr) return; selectByCode(tr.getAttribute(\"data-code\")); });

// Importar JSON por arrastre/bot√≥n
const drop = document.querySelector(\"#drop\"), file = document.querySelector(\"#file\");
[\"dragenter\",\"dragover\"].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add(\"drag\"); }));
[\"dragleave\",\"drop\"].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove(\"drag\"); }));
drop.addEventListener(\"drop\", e=>{ const f=e.dataTransfer.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>loadFromText(reader.result); reader.readAsText(f,\"utf-8\"); });
document.querySelector(\"#btnImport\").addEventListener(\"click\", ()=>file.click());
file.addEventListener(\"change\", ()=>{ const f=file.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>loadFromText(reader.result); reader.readAsText(f,\"utf-8\"); });
document.querySelector(\"#btnReset\").addEventListener(\"click\", ()=>{ data=[...demo]; initFilters(); applyFilters(); selectByCode(\"430\"); });

function loadFromText(text){
  try{
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error(\"El JSON debe ser un array de objetos.\");
    if(!arr.every(o=>o.code && o.name)) throw new Error(\"Cada objeto necesita 'code' y 'name'.\");
    data = arr; initFilters(); applyFilters(); if(data.length) selectByCode(String(data[0].code));
    alert(`Se han cargado ${data.length.toLocaleString(\"es-ES\")} registros.`);
  }catch(err){ console.error(err); alert(\"No se pudo cargar el JSON: \"+err.message); }
}

// 4) Auto-carga desde misma carpeta
(async () => {
  try{
    const resp = await fetch(\"./pgc_cuadro_cuentas_demo.json\", {cache: \"no-store\"});
    if (!resp.ok) throw new Error(\"No encontrado\");
    const arr = await resp.json();
    data = arr;
  }catch(e){
    console.warn(\"No se pudo cargar pgc_cuadro_cuentas_demo.json; usando DEMO interno.\", e);
    data = [...demo];
  }
  initFilters(); applyFilters(); if (data.length) selectByCode(String(data[0].code));
})();
</script>
</body>
</html>