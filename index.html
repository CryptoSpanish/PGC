# Generate an improved HTML that:
# - Intenta cargar varias fuentes JSON en cascada hasta encontrar datos v√°lidos
# - Muestra mensajes de estado m√°s claros
# - Mantiene scroll oculto y UI simplificada (sin selector/importar)
# - Conserva tabla + acorde√≥n + panel de explicaci√≥n
html = r"""<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PGC ¬∑ JSON din√°mico (fallback autom√°tico) ¬∑ Scroll oculto</title>
<meta name="description" content="Explorador del PGC consumiendo JSON externo; carga en cascada hasta encontrar datos v√°lidos." />
<style>
  :root{ --bg:#0b0f14; --panel:#0f1621; --muted:#8aa0bc; --text:#e7eef8; --accent:#5dd0ff; --card:#0d131d; --border:#1b2431; --chip:#132032; --hl:#1a263a }
  *{box-sizing:border-box}
  html{ scrollbar-width:none; -ms-overflow-style:none; } html::-webkit-scrollbar{ display:none; }
  body{margin:0; font-family:system-ui,Inter,Roboto,Segoe UI,Arial; color:var(--text); background:linear-gradient(180deg,#0a0e13,#0b0f14)}
  header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(13,19,29,.92),rgba(13,19,29,.65)); border-bottom:1px solid var(--border); backdrop-filter:blur(8px)}
  .wrap{max-width:1200px; margin:0 auto; padding:16px 18px}
  h1{margin:0; font-size:1.5rem; display:flex; gap:.6rem; align-items:center}
  h1 .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 14px var(--accent)}
  .sub{color:var(--muted); margin-top:6px}
  .toolbar{display:grid; grid-template-columns:1.2fr .9fr; gap:10px; margin-top:12px}
  .control{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:center}
  .control input{all:unset; flex:1}
  .control select{all:unset; background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:10px}
  main{display:grid; grid-template-columns:1fr 420px; gap:14px; margin-top:14px}
  @media (max-width:1050px){ main{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden}
  .card h2{margin:0; padding:12px 14px; border-bottom:1px solid var(--border); background:#0f1723; font-size:1rem}
  .table-wrap{max-height:45vh; overflow:auto}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{position:sticky; top:0; background:#0f1a2b; color:#c4d2e6; text-align:left; padding:8px 10px; border-bottom:1px solid var(--border); font-size:.9rem}
  tbody td{padding:8px 10px; border-bottom:1px solid var(--border); font-size:.95rem}
  td.code{font-variant-numeric:tabular-nums; font-weight:700; color:#dff5ff}
  .badge span{display:inline-block; background:var(--chip); border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:.75rem}
  .footer-tools{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 10px; border-top:1px solid var(--border); color:#8aa0bc}
  .pager .btn{padding:6px 8px; background:#142032; border:1px solid var(--border); color:var(--text); border-radius:10px; cursor:pointer}
  .accordion{max-height:calc(100vh - 220px); overflow:auto}
  details{border-top:1px solid var(--border)} details:first-child{border-top:0}
  details[open]{background:var(--hl)}
  summary{list-style:none; cursor:pointer; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  summary::-webkit-details-marker{display:none}
  .sum-left{display:flex; gap:10px; align-items:center}
  .pill{font-variant-numeric:tabular-nums; font-weight:700; background:#0f2136; border:1px solid var(--border); padding:2px 8px; border-radius:8px; color:#dff5ff}
  .meta{display:grid; grid-template-columns:140px 1fr; gap:6px 10px; padding:0 14px 12px 14px}
  .meta div:nth-child(odd){color:#a9bbd6; font-size:.9rem}
  .meta div:nth-child(even){color:#ecf5ff}
  .chips{display:flex; flex-wrap:wrap; gap:6px; padding:0 14px 12px}
  .chip{background:var(--chip); border:1px solid var(--border); padding:3px 8px; border-radius:999px; font-size:.78rem}
  .explain{padding:0 14px 14px; color:#d6e8ff}
  .status{font-size:.9rem}
  .err{color:#ff9b9b}
  .ok{color:#90f0c4}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="dot"></span> Plan General Contable ‚Äî JSON din√°mico</h1>
    <div class="sub">Carga en cascada: intento <b>flat</b> ‚Üí si est√° vac√≠o, <b>demo</b> ‚Üí si no existe, <b>nested</b> con aplanado autom√°tico. Scroll sin barra visible.</div>
    <div class="toolbar">
      <div class="control">üîé
        <input id="q" placeholder="Buscar por c√≥digo, nombre, grupo‚Ä¶ (p. ej., 430, bancos, proveedores)">
      </div>
      <div class="control">
        <select id="fGroup"><option value="">Grupo (1‚Äì9)</option></select>
        <select id="fNature">
          <option value="">Naturaleza</option>
          <option>Activo</option><option>Pasivo</option><option>Patrimonio neto</option>
          <option>Gasto</option><option>Ingreso</option>
        </select>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <main>
    <section class="card">
      <h2>Cuadro de cuentas ¬∑ resultados <span id="count"></span></h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th><th>Nombre</th><th>Grupo</th><th>Subgrupo</th><th>Naturaleza</th><th>Presentaci√≥n</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="footer-tools">
        <div class="pager">
          <button class="btn" id="prev">‚Üê</button>
          <span id="pageInfo"></span>
          <button class="btn" id="next">‚Üí</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </section>

    <aside class="card">
      <h2>Explicaci√≥n r√°pida (selecci√≥n actual)</h2>
      <div class="meta">
        <div>C√≥digo</div>      <div id="d_code">‚Äî</div>
        <div>Nombre</div>      <div id="d_name">‚Äî</div>
        <div>Jerarqu√≠a</div>   <div id="d_path">‚Äî</div>
        <div>Naturaleza</div>  <div id="d_nature">‚Äî</div>
        <div>Saldo normal</div><div id="d_balance">‚Äî</div>
        <div>Presentaci√≥n</div><div id="d_present">‚Äî</div>
      </div>
      <div class="chips" id="chips"></div>
    </aside>
  </main>

  <section class="card" style="margin-top:14px">
    <h2>Desplegable por c√≥digos (explicaci√≥n t√©cnica)</h2>
    <div id="accordion" class="accordion"></div>
  </section>
</div>

<script>
/* 0) Fuentes en cascada (mismo directorio del HTML) */
const SOURCES = [
  {id:"flat",  url:"./pgc_cuadro_cuentas_flat.json",   label:"flat (plano)"},
  {id:"demo",  url:"./pgc_cuadro_cuentas_demo.json",   label:"demo (plano)"},
  {id:"nested",url:"./pgc_cuadro_cuentas_nested.json", label:"nested (jer√°rquico)"}
];

/* 1) Utils + reglas */
const $=(s,c=document)=>c.querySelector(s);
const rows=$("#rows"), q=$("#q"), fGroup=$("#fGroup"), fNature=$("#fNature");
const pageInfo=$("#pageInfo"), count=$("#count"), statusEl=$("#status");

function rulesFor(code){
  const g = String(code).trim()[0];
  let nature="", balance="", present="", tags=[];
  switch(g){
    case "1": nature=(code.startsWith("10")||code.startsWith("11"))?"Patrimonio neto":"Pasivo"; balance="Acreedor"; present="Balance (no corriente / financiaci√≥n b√°sica)"; break;
    case "2": nature="Activo"; balance="Deudor"; present="Balance (activo no corriente)"; break;
    case "3": nature="Activo"; balance="Deudor"; present="Balance (existencias ¬∑ activo corriente)"; break;
    case "4":
      if(/^43/.test(code)){ nature="Activo"; balance="Deudor"; present="Balance (cr√©ditos comerciales ¬∑ corriente)"; }
      else if(/^47/.test(code)){ nature="Activo/Pasivo"; balance="Mixto"; present="Balance (Hacienda P√∫blica ¬∑ corriente)"; tags.push("Regularizable"); }
      else { nature="Pasivo"; balance="Acreedor"; present="Balance (deudas comerciales ¬∑ corriente)"; }
      break;
    case "5":
      if(/^57/.test(code)){ nature="Activo"; balance="Deudor"; present="Balance (tesorer√≠a ¬∑ corriente)"; }
      else if(/^52/.test(code)){ nature="Pasivo"; balance="Acreedor"; present="Balance (deudas financieras ¬∑ corriente)"; }
      else { nature="Activo/Pasivo"; balance="Mixto"; present="Balance (cuentas financieras)"; }
      break;
    case "6": nature="Gasto"; balance="Deudor"; present="Cuenta de P√©rdidas y Ganancias (gastos)"; break;
    case "7": nature="Ingreso"; balance="Acreedor"; present="Cuenta de P√©rdidas y Ganancias (ingresos)"; break;
    case "8": nature="Gasto"; balance="Deudor"; present="Estado de Cambios en el Patrimonio Neto (gastos)"; break;
    case "9": nature="Ingreso"; balance="Acreedor"; present="Estado de Cambios en el Patrimonio Neto (ingresos)"; break;
  }
  if (g==="6"||g==="7") tags.push("Devengo","PyG");
  if (g==="8"||g==="9") tags.push("Ajuste a PN");
  return {nature,balance,present,tags};
}
function normalizeFlat(r){
  const meta = rulesFor(r.code);
  return {...r,
    group: r.group || `${String(r.code)[0]} ‚Äì Grupo`,
    nature: r.nature || meta.nature,
    balance: r.balance || meta.balance,
    present: r.present || meta.present,
    _tags: meta.tags
  };
}
function fromNestedToFlat(nested){
  const out=[];
  (nested||[]).forEach(g=>{
    const gLabel = `${g.code} ‚Äì ${g.name||"Grupo"}`;
    (g.subgroups||[]).forEach(sg=>{
      const sgLabel = `${sg.code} ‚Äì ${sg.name||"Subgrupo"}`;
      (sg.accounts||[]).forEach(acc=>{
        out.push({code:String(acc.code), name:acc.name, group:gLabel, subgroup:sgLabel});
      });
    });
  });
  return out;
}

/* 2) Estado y render */
let data=[]; let filtered=[]; let page=1; const pageSize=14; let selection=null;

function initFilterOptions(){
  const groups = [...new Set(data.map(x=>String(x.code)[0]))].sort();
  fGroup.innerHTML = '<option value="">Grupo (1‚Äì9)</option>' + groups.map(g=>{
    const label = ({"1":"1 ‚Äì Financiaci√≥n b√°sica","2":"2 ‚Äì Activo no corriente","3":"3 ‚Äì Existencias","4":"4 ‚Äì Acreedores y deudores por operaciones comerciales","5":"5 ‚Äì Cuentas financieras","6":"6 ‚Äì Compras y gastos","7":"7 ‚Äì Ventas e ingresos","8":"8 ‚Äì Gastos a PN","9":"9 ‚Äì Ingresos a PN"})[g] || (g+" ‚Äì Grupo");
    return `<option value="${g}">${label}</option>`;
  }).join("");
}
function applyFilters(){
  const term = q.value.trim().toLowerCase();
  const g = fGroup.value; const n = fNature.value;
  const withMeta = data.map(normalizeFlat);
  filtered = withMeta.filter(r=>{
    const passG = g ? String(r.code).startsWith(g) : true;
    const passN = n ? r.nature===n : true;
    const text = [r.code,r.name,r.group,r.subgroup,r.nature,r.present].join(" ").toLowerCase();
    const passQ = term ? text.includes(term) : true;
    return passG && passN && passQ;
  });
  page=1; renderTable(); renderAccordion();
}
function hl(text, term){
  if(!term) return text;
  const esc = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return text.replace(new RegExp(esc,"ig"), m=>`<mark>${m}</mark>`);
}
function renderTable(){
  const term=q.value.trim(); const total=filtered.length; const start=(page-1)*pageSize; const end=Math.min(start+pageSize,total);
  const view=filtered.slice(start,end);
  rows.innerHTML = view.map(r=>`
    <tr data-code="${r.code}">
      <td class="code">${hl(r.code,term)}</td>
      <td>${hl(r.name,term)}</td>
      <td class="badge"><span>${hl(r.group,term)}</span></td>
      <td class="badge"><span>${hl(r.subgroup||"‚Äî",term)}</span></td>
      <td>${r.nature||"‚Äî"}</td>
      <td>${r.present||"‚Äî"}</td>
    </tr>`).join("");
  count.textContent = total ? `¬∑ ${total.toLocaleString("es-ES")} coincidencia(s)` : "¬∑ 0";
  pageInfo.textContent = total ? `P√°gina ${page} ¬∑ ${start+1}‚Äì${end} / ${total}` : "Sin resultados";
}
function describe(r){
  const m = rulesFor(r.code);
  const partes = [];
  partes.push(`La cuenta <b>${r.code} ‚Äî ${r.name}</b> se encuadra en <i>${r.group}</i>${r.subgroup?` ‚Üí <i>${r.subgroup}</i>`:""}.`);
  partes.push(`Por su naturaleza se clasifica como <b>${m.nature}</b> con saldo normal <b>${m.balance}</b>.`);
  partes.push(`En los estados financieros se presenta en: <b>${m.present}</b>.`);
  if (m.tags?.length) partes.push(`Etiquetas: ${m.tags.join(", ")}.`);
  return partes.join(" ");
}
function renderAccordion(){
  const acc=$("#accordion"); const term=q.value.trim();
  acc.innerHTML = filtered.map(r=>{
    const title = `${r.code} ‚Äî ${r.name}`;
    const desc  = describe(r);
    const chips = (r._tags||[]).map(t=>`<span class="chip">${t}</span>`).join("");
    return `<details id="acc-${r.code}">
      <summary>
        <div class="sum-left"><span class="pill">${r.code}</span> <span>${hl(title, term)}</span></div>
        <div class="badge"><span>${r.nature||rulesFor(r.code).nature}</span></div>
      </summary>
      <div class="meta">
        <div>C√≥digo</div><div>${r.code}</div>
        <div>Nombre</div><div>${r.name}</div>
        <div>Jerarqu√≠a</div><div>${r.group} ${r.subgroup?("‚Üí "+r.subgroup):""}</div>
        <div>Naturaleza</div><div>${r.nature||rulesFor(r.code).nature}</div>
        <div>Saldo normal</div><div>${r.balance||rulesFor(r.code).balance}</div>
        <div>Presentaci√≥n</div><div>${r.present||rulesFor(r.code).present}</div>
      </div>
      <div class="chips">${chips}</div>
      <div class="explain">${desc}</div>
    </details>`;
  }).join("");
}

/* 3) Carga de JSON con fallback */
async function tryLoad(url){
  const label = (SOURCES.find(s=>s.url===url)||{}).label || url;
  statusEl.innerHTML = `Intentando <b>${label}</b>‚Ä¶`;
  const resp = await fetch(url, {cache:"no-store"});
  if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
  return resp.json();
}
function toFlat(json){
  if (Array.isArray(json)) return json;
  const nested = json.groups || json || [];
  return fromNestedToFlat(Array.isArray(nested)?nested:[nested]);
}
async function loadCascade(){
  let lastErr=null;
  for (const s of SOURCES){
    try{
      const obj = await tryLoad(s.url);
      let flat = toFlat(obj).map(x=>({code:String(x.code), name:x.name, group:x.group, subgroup:x.subgroup}));
      flat = flat.filter(x=>x.code && x.name); // sanidad
      if (flat.length){
        data = flat.sort((a,b)=>a.code.localeCompare(b.code,'es',{numeric:true}));
        initFilterOptions(); applyFilters(); if(data.length) selectByCode(data[0].code);
        statusEl.innerHTML = `<span class="ok">Cargado desde ${s.label}: ${data.length.toLocaleString("es-ES")} cuentas.</span>`;
        return;
      }else{
        lastErr = new Error("sin registros v√°lidos");
      }
    }catch(e){ lastErr = e; }
  }
  statusEl.innerHTML = `<span class="err">No pude cargar datos desde ninguna fuente (${SOURCES.map(s=>s.label).join(" ‚Üí ")}). √öltimo error: ${lastErr?.message||"desconocido"}.</span>`;
}

/* 4) Interacciones */
function selectByCode(code){
  const r = filtered.find(x=>x.code===code) || data.find(x=>x.code===code);
  if(!r) return;
  const m = rulesFor(r.code);
  $("#d_code").textContent = r.code;
  $("#d_name").textContent = r.name;
  $("#d_path").textContent = `${r.group}${r.subgroup?(" ‚Üí "+r.subgroup):""} ‚Üí ${r.code}`;
  $("#d_nature").textContent = r.nature||m.nature;
  $("#d_balance").textContent = r.balance||m.balance;
  $("#d_present").textContent = r.present||m.present;
  const chips = $("#chips"); chips.innerHTML=""; (m.tags||[]).forEach(t=>{ const el=document.createElement("span"); el.className="chip"; el.textContent=t; chips.appendChild(el); });
  const det = document.querySelector(`#acc-${r.code}`); if(det) det.open = true;
}
q.addEventListener("input", applyFilters);
fGroup.addEventListener("change", applyFilters);
fNature.addEventListener("change", applyFilters);
$("#prev").addEventListener("click", ()=>{ if(page>1){ page--; renderTable(); }});
$("#next").addEventListener("click", ()=>{ const pages=Math.ceil(filtered.length/14); if(page<pages){ page++; renderTable(); }});

/* 5) Inicio */
loadCascade();
</script>
</body>
</html>"""
out = "/mnt/data/index_pgc_json_fallback_scroll.html"
with open(out, "w", encoding="utf-8") as f:
    f.write(html)
out
