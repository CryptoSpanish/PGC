<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PGC ¬∑ Tabla + Desplegables ¬∑ Datos desde JSON</title>
<meta name="description" content="Explorador del PGC consumiendo archivos JSON externos (plano o jer√°rquico)." />
<style>
  :root{ --bg:#0b0f14; --panel:#0f1621; --muted:#8aa0bc; --text:#e7eef8; --accent:#5dd0ff; --card:#0d131d; --border:#1b2431; --chip:#132032; --hl:#1a263a }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Inter,Roboto,Segoe UI,Arial; color:var(--text); background:linear-gradient(180deg,#0a0e13,#0b0f14)}
  header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(13,19,29,.92),rgba(13,19,29,.65)); border-bottom:1px solid var(--border); backdrop-filter:blur(8px)}
  .wrap{max-width:1200px; margin:0 auto; padding:16px 18px}
  h1{margin:0; font-size:1.5rem; display:flex; gap:.6rem; align-items:center}
  h1 .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 14px var(--accent)}
  .sub{color:var(--muted); margin-top:6px}
  .toolbar{display:grid; grid-template-columns:1.2fr .9fr .9fr auto; gap:10px; margin-top:12px}
  .control{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:center}
  .control input{all:unset; flex:1}
  .control select{all:unset; background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:10px}
  .btn{background:#142032; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  main{display:grid; grid-template-columns:1fr 420px; gap:14px; margin-top:14px}
  @media (max-width:1050px){ main{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden}
  .card h2{margin:0; padding:12px 14px; border-bottom:1px solid var(--border); background:#0f1723; font-size:1rem}
  .table-wrap{max-height:45vh; overflow:auto}
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{position:sticky; top:0; background:#0f1a2b; color:#c4d2e6; text-align:left; padding:8px 10px; border-bottom:1px solid var(--border); font-size:.9rem}
  tbody td{padding:8px 10px; border-bottom:1px solid var(--border); font-size:.95rem}
  td.code{font-variant-numeric:tabular-nums; font-weight:700; color:#dff5ff}
  .badge span{display:inline-block; background:var(--chip); border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:.75rem}
  .footer-tools{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 10px; border-top:1px solid var(--border); color:var(--muted)}
  .pager .btn{padding:6px 8px}
  .accordion{max-height:calc(100vh - 220px); overflow:auto}
  details{border-top:1px solid var(--border)} details:first-child{border-top:0}
  details[open]{background:var(--hl)}
  summary{list-style:none; cursor:pointer; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  summary::-webkit-details-marker{display:none}
  .sum-left{display:flex; gap:10px; align-items:center}
  .pill{font-variant-numeric:tabular-nums; font-weight:700; background:#0f2136; border:1px solid var(--border); padding:2px 8px; border-radius:8px; color:#dff5ff}
  .meta{display:grid; grid-template-columns:140px 1fr; gap:6px 10px; padding:0 14px 12px 14px}
  .meta div:nth-child(odd){color:#a9bbd6; font-size:.9rem}
  .meta div:nth-child(even){color:#ecf5ff}
  .chips{display:flex; flex-wrap:wrap; gap:6px; padding:0 14px 12px}
  .chip{background:var(--chip); border:1px solid var(--border); padding:3px 8px; border-radius:999px; font-size:.78rem}
  .explain{padding:0 14px 14px; color:#d6e8ff}
  .error{color:#ffb3b3; font-size:.92rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1><span class="dot"></span> Plan General Contable ‚Äî JSON din√°mico</h1>
    <div class="sub">Trabajo con archivos JSON (plano o jer√°rquico). Cambia de fuente arriba o importa otro fichero.</div>
    <div class="toolbar">
      <div class="control">üîé
        <input id="q" placeholder="Buscar por c√≥digo, nombre, grupo‚Ä¶ (p. ej., 430, bancos, proveedores)">
      </div>
      <div class="control">
        <select id="fGroup"><option value="">Grupo (1‚Äì9)</option></select>
        <select id="fNature">
          <option value="">Naturaleza</option>
          <option>Activo</option><option>Pasivo</option><option>Patrimonio neto</option>
          <option>Gasto</option><option>Ingreso</option>
        </select>
      </div>
      <div class="control" style="gap:8px">
        <select id="source"></select>
        <button class="btn" id="btnReload">Recargar</button>
        <button class="btn" id="btnImport">Importar JSON</button>
        <input id="file" type="file" accept=".json,application/json" hidden>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <main>
    <!-- Tabla -->
    <section class="card">
      <h2>Cuadro de cuentas ¬∑ resultados <span id="count" style="color:#8aa0bc"></span></h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th><th>Nombre</th><th>Grupo</th><th>Subgrupo</th><th>Naturaleza</th><th>Presentaci√≥n</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="footer-tools">
        <div class="pager">
          <button class="btn" id="prev">‚Üê</button>
        <span id="pageInfo"></span>
          <button class="btn" id="next">‚Üí</button>
        </div>
        <span>Haz clic en una fila para abrir su desplegable. <span id="status" class="error"></span></span>
      </div>
    </section>

    <!-- Panel de explicaci√≥n puntual (selecci√≥n desde tabla) -->
    <aside class="card">
      <h2>Explicaci√≥n r√°pida (selecci√≥n actual)</h2>
      <div class="meta">
        <div>C√≥digo</div>      <div id="d_code">‚Äî</div>
        <div>Nombre</div>      <div id="d_name">‚Äî</div>
        <div>Jerarqu√≠a</div>   <div id="d_path">‚Äî</div>
        <div>Naturaleza</div>  <div id="d_nature">‚Äî</div>
        <div>Saldo normal</div><div id="d_balance">‚Äî</div>
        <div>Presentaci√≥n</div><div id="d_present">‚Äî</div>
      </div>
      <div class="chips" id="chips"></div>
    </aside>
  </main>

  <!-- Desplegables (acorde√≥n) -->
  <section class="card" style="margin-top:14px">
    <h2>Desplegable por c√≥digos (explicaci√≥n t√©cnica)</h2>
    <div id="accordion" class="accordion"></div>
  </section>
</div>

<script>
/* =========================
   0) Configuraci√≥n de fuentes
   ========================= */
const DATA_SOURCES = [
  {id:"demo",  label:"demo (plano)", url:"./pgc_cuadro_cuentas_demo.json"},
  {id:"flat",  label:"flat (plano)", url:"./pgc_cuadro_cuentas_flat.json"},
  {id:"nested",label:"nested (jer√°rquico)", url:"./pgc_cuadro_cuentas_nested.json"}
];

/* =========================
   1) Utilidades y reglas PGC
   ========================= */
const $=(s,c=document)=>c.querySelector(s), $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const rows=$("#rows"), q=$("#q"), fGroup=$("#fGroup"), fNature=$("#fNature");
const pageInfo=$("#pageInfo"), count=$("#count"), statusEl=$("#status"), sourceSel=$("#source");

function rulesFor(code){
  const g = String(code).trim()[0];
  let nature="", balance="", present="", tags=[];
  switch(g){
    case "1": nature=(code.startsWith("10")||code.startsWith("11"))?"Patrimonio neto":"Pasivo"; balance="Acreedor"; present="Balance (no corriente / financiaci√≥n b√°sica)"; break;
    case "2": nature="Activo"; balance="Deudor"; present="Balance (activo no corriente)"; break;
    case "3": nature="Activo"; balance="Deudor"; present="Balance (existencias ¬∑ activo corriente)"; break;
    case "4":
      if(/^43/.test(code)){ nature="Activo"; balance="Deudor"; present="Balance (cr√©ditos comerciales ¬∑ corriente)"; }
      else if(/^47/.test(code)){ nature="Activo/Pasivo"; balance="Mixto"; present="Balance (Hacienda P√∫blica ¬∑ corriente)"; tags.push("Regularizable"); }
      else { nature="Pasivo"; balance="Acreedor"; present="Balance (deudas comerciales ¬∑ corriente)"; }
      break;
    case "5":
      if(/^57/.test(code)){ nature="Activo"; balance="Deudor"; present="Balance (tesorer√≠a ¬∑ corriente)"; }
      else if(/^52/.test(code)){ nature="Pasivo"; balance="Acreedor"; present="Balance (deudas financieras ¬∑ corriente)"; }
      else { nature="Activo/Pasivo"; balance="Mixto"; present="Balance (cuentas financieras)"; }
      break;
    case "6": nature="Gasto"; balance="Deudor"; present="Cuenta de P√©rdidas y Ganancias (gastos)"; break;
    case "7": nature="Ingreso"; balance="Acreedor"; present="Cuenta de P√©rdidas y Ganancias (ingresos)"; break;
    case "8": nature="Gasto"; balance="Deudor"; present="Estado de Cambios en el Patrimonio Neto (gastos)"; break;
    case "9": nature="Ingreso"; balance="Acreedor"; present="Estado de Cambios en el Patrimonio Neto (ingresos)"; break;
  }
  if (g==="6"||g==="7") tags.push("Devengo","PyG");
  if (g==="8"||g==="9") tags.push("Ajuste a PN");
  return {nature,balance,present,tags};
}

function normalizeFlat(r){
  const meta = rulesFor(r.code);
  return {...r,
    group: r.group || `${String(r.code)[0]} ‚Äì Grupo`,
    nature: r.nature || meta.nature,
    balance: r.balance || meta.balance,
    present: r.present || meta.present,
    _tags: meta.tags
  };
}
function fromNestedToFlat(nested){
  const out=[];
  (nested||[]).forEach(g=>{
    const gLabel = `${g.code} ‚Äì ${g.name||"Grupo"}`;
    (g.subgroups||[]).forEach(sg=>{
      const sgLabel = `${sg.code} ‚Äì ${sg.name||"Subgrupo"}`;
      (sg.accounts||[]).forEach(acc=>{
        out.push({code:String(acc.code), name:acc.name, group:gLabel, subgroup:sgLabel});
      });
    });
  });
  return out;
}

/* =========================
   2) Estado y render
   ========================= */
let data=[]; let filtered=[]; let page=1; const pageSize=14; let selection=null;

function initFilterOptions(){
  const groups = [...new Set(data.map(x=>String(x.code)[0]))].sort();
  fGroup.innerHTML = '<option value="">Grupo (1‚Äì9)</option>' + groups.map(g=>{
    const label = ({"1":"1 ‚Äì Financiaci√≥n b√°sica","2":"2 ‚Äì Activo no corriente","3":"3 ‚Äì Existencias","4":"4 ‚Äì Acreedores y deudores por operaciones comerciales","5":"5 ‚Äì Cuentas financieras","6":"6 ‚Äì Compras y gastos","7":"7 ‚Äì Ventas e ingresos","8":"8 ‚Äì Gastos a PN","9":"9 ‚Äì Ingresos a PN"})[g] || (g+" ‚Äì Grupo");
    return `<option value="${g}">${label}</option>`;
  }).join("");
}
function applyFilters(){
  const term = q.value.trim().toLowerCase();
  const g = fGroup.value; const n = fNature.value;
  const withMeta = data.map(normalizeFlat);
  filtered = withMeta.filter(r=>{
    const passG = g ? String(r.code).startsWith(g) : true;
    const passN = n ? r.nature===n : true;
    const text = [r.code,r.name,r.group,r.subgroup,r.nature,r.present].join(" ").toLowerCase();
    const passQ = term ? text.includes(term) : true;
    return passG && passN && passQ;
  });
  page=1; renderTable(); renderAccordion();
}
function hl(text, term){
  if(!term) return text;
  const esc = term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return text.replace(new RegExp(esc,"ig"), m=>`<mark>${m}</mark>`);
}
function renderTable(){
  const term=q.value.trim(); const total=filtered.length; const start=(page-1)*pageSize; const end=Math.min(start+pageSize,total);
  const view=filtered.slice(start,end);
  rows.innerHTML = view.map(r=>`
    <tr data-code="${r.code}">
      <td class="code">${hl(r.code,term)}</td>
      <td>${hl(r.name,term)}</td>
      <td class="badge"><span>${hl(r.group,term)}</span></td>
      <td class="badge"><span>${hl(r.subgroup||"‚Äî",term)}</span></td>
      <td>${r.nature||"‚Äî"}</td>
      <td>${r.present||"‚Äî"}</td>
    </tr>`).join("");
  count.textContent = total ? `¬∑ ${total.toLocaleString("es-ES")} coincidencia(s)` : "¬∑ 0";
  pageInfo.textContent = total ? `P√°gina ${page} ¬∑ ${start+1}‚Äì${end} / ${total}` : "Sin resultados";
}
function describe(r){
  const m = rulesFor(r.code);
  const partes = [];
  partes.push(`La cuenta <b>${r.code} ‚Äî ${r.name}</b> se encuadra en <i>${r.group}</i>${r.subgroup?` ‚Üí <i>${r.subgroup}</i>`:""}.`);
  partes.push(`Por su naturaleza se clasifica como <b>${m.nature}</b> con saldo normal <b>${m.balance}</b>.`);
  partes.push(`En los estados financieros se presenta en: <b>${m.present}</b>.`);
  if (m.tags?.length) partes.push(`Etiquetas: ${m.tags.join(", ")}.`);
  return partes.join(" ");
}
function renderAccordion(){
  const acc=$("#accordion"); const term=q.value.trim();
  acc.innerHTML = filtered.map(r=>{
    const title = `${r.code} ‚Äî ${r.name}`;
    const desc  = describe(r);
    const chips = (r._tags||[]).map(t=>`<span class="chip">${t}</span>`).join("");
    return `<details id="acc-${r.code}">
      <summary>
        <div class="sum-left"><span class="pill">${r.code}</span> <span>${hl(title, term)}</span></div>
        <div class="badge"><span>${r.nature||rulesFor(r.code).nature}</span></div>
      </summary>
      <div class="meta">
        <div>C√≥digo</div><div>${r.code}</div>
        <div>Nombre</div><div>${r.name}</div>
        <div>Jerarqu√≠a</div><div>${r.group} ${r.subgroup?("‚Üí "+r.subgroup):""}</div>
        <div>Naturaleza</div><div>${r.nature||rulesFor(r.code).nature}</div>
        <div>Saldo normal</div><div>${r.balance||rulesFor(r.code).balance}</div>
        <div>Presentaci√≥n</div><div>${r.present||rulesFor(r.code).present}</div>
      </div>
      <div class="chips">${chips}</div>
      <div class="explain">${desc}</div>
    </details>`;
  }).join("");
}

/* =========================
   3) Carga de JSON (fetch)
   ========================= */
async function loadSource(url){
  statusEl.textContent = ""; $("#btnReload").disabled = true;
  try{
    const resp = await fetch(url, {cache:"no-store"});
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    let flat;
    if (Array.isArray(json)) {              // plano
      flat = json;
    } else if (Array.isArray(json?.subgroups) || Array.isArray(json?.accounts) || Array.isArray(json?.groups)) {
      // algunos exportan {groups:[...]} otros un array de groups
      const nested = Array.isArray(json) ? json : (json.groups || [json]);
      flat = fromNestedToFlat(nested);
    } else {                                // quiz√° sea un objeto con groups:[...]
      const nested = json.groups || [];
      flat = fromNestedToFlat(nested);
    }
    // Normalizo, ordeno y pinto
    data = (flat||[]).map(x=>({code:String(x.code), name:x.name, group:x.group, subgroup:x.subgroup})).sort((a,b)=>a.code.localeCompare(b.code,'es',{numeric:true}));
    if(!data.length) throw new Error("El JSON se carg√≥ pero no contiene cuentas reconocibles.");
    initFilterOptions(); applyFilters();
    if(data.length) selectByCode(data[0].code);
  }catch(err){
    console.error(err);
    statusEl.textContent = `No pude cargar ${url}: ${err.message}`;
    data = []; filtered=[]; renderTable(); $("#accordion").innerHTML = "";
  }finally{
    $("#btnReload").disabled = false;
  }
}

/* =========================
   4) Interacciones UI
   ========================= */
function selectByCode(code){
  const r = filtered.find(x=>x.code===code) || data.find(x=>x.code===code);
  if(!r){ return; }
  const m = rulesFor(r.code);
  $("#d_code").textContent = r.code;
  $("#d_name").textContent = r.name;
  $("#d_path").textContent = `${r.group}${r.subgroup?(" ‚Üí "+r.subgroup):""} ‚Üí ${r.code}`;
  $("#d_nature").textContent = r.nature||m.nature;
  $("#d_balance").textContent = r.balance||m.balance;
  $("#d_present").textContent = r.present||m.present;
  const chips = $("#chips"); chips.innerHTML=""; (m.tags||[]).forEach(t=>{ const el=document.createElement("span"); el.className="chip"; el.textContent=t; chips.appendChild(el); });
  const det = document.querySelector(`#acc-${r.code}`); if(det) det.open = true;
}
// filtros/b√∫squeda
q.addEventListener("input", applyFilters);
fGroup.addEventListener("change", applyFilters);
fNature.addEventListener("change", applyFilters);
// paginaci√≥n
$("#prev").addEventListener("click", ()=>{ if(page>1){ page--; renderTable(); }});
$("#next").addEventListener("click", ()=>{ const pages=Math.ceil(filtered.length/14); if(page<pages){ page++; renderTable(); }});
// click fila ‚Üí abre su details
rows.addEventListener("click", (e)=>{ const tr=e.target.closest("tr"); if(!tr) return; selectByCode(tr.getAttribute("data-code")); });
// cambiar fuente / recargar
$("#btnReload").addEventListener("click", ()=> loadSource(sourceSel.value));
sourceSel.addEventListener("change", ()=> loadSource(sourceSel.value));
// importar JSON manual
$("#btnImport").addEventListener("click", ()=> $("#file").click());
$("#file").addEventListener("change", ()=>{
  const f = $("#file").files?.[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{ try{
    const obj = JSON.parse(reader.result);
    const flat = Array.isArray(obj) ? obj : fromNestedToFlat(obj.groups||obj);
    data = (flat||[]).map(x=>({code:String(x.code), name:x.name, group:x.group, subgroup:x.subgroup}));
    initFilterOptions(); applyFilters(); if(data.length) selectByCode(data[0].code);
  }catch(e){ statusEl.textContent="Importaci√≥n fallida: "+e.message; } };
  reader.readAsText(f,"utf-8");
});

/* =========================
   5) Inicio
   ========================= */
function boot(){
  // fuentes disponibles en el selector
  sourceSel.innerHTML = DATA_SOURCES.map(s=>`<option value="${s.url}">${s.label}</option>`).join("");
  // por defecto, la primera
  loadSource(DATA_SOURCES[0].url);
}
boot();
</script>
</body>
</html>
